library(dplyr)


utforsk90 <- regdata |> filter(operation_group == "Whipple's procedure") |>
  select(OPERATION_DATE, RELAPAROTOMY, RELAPAROTOMY_READMISSION,
         STATUS, STATUS_READMISSION, STATUS_READMISSION90,
         DEATH, DEATH_DATE, FOLLOWUP_STATUS)


utforsk90 <- regdata |> filter(operation_group == "Whipple's procedure") |>
  select(OPERATION_DATE, RELAPAROTOMY, RELAPAROTOMY_YES, RELAPAROTOMY_NO, RELAPAROTOMY_READMISSION,
         STATUS, STATUS_READMISSION, STATUS_READMISSION90,
         DEATH, DEATH_DATE, IN_HOUSE_DEATH, IN_HOUSE_DEATH_DATE,
         IN_HOUSE_DEATH_READMISSION, IN_HOUSE_DEATH_DATE_READMISSION, FOLLOWUP_STATUS)

utforsk90 <- regdata |> filter(operation_group == "Colonic resection") |>
  select(OPERATION_DATE, RELAPAROTOMY, RELAPAROTOMY_YES, RELAPAROTOMY_NO, RELAPAROTOMY_READMISSION,
         STATUS, STATUS_READMISSION, STATUS_READMISSION90,
         DEATH, DEATH_DATE, IN_HOUSE_DEATH, IN_HOUSE_DEATH_DATE,
         IN_HOUSE_DEATH_READMISSION, IN_HOUSE_DEATH_DATE_READMISSION, FOLLOWUP_STATUS)

mort <- regdata |>
  filter(OPERATION_DATE < "2025-09-15") |>
  filter(operation_group != "Other") |>
  summarise(
    n_mort_base = sum(IN_HOUSE_DEATH, na.rm = T),
    n_mort_30 = sum(IN_HOUSE_DEATH_READMISSION, na.rm = T),
    n_mort_90 = sum(DEATH == 1, na.rm = T),
    n_mort = sum(IN_HOUSE_DEATH | IN_HOUSE_DEATH_READMISSION |
                   DEATH == 1, na.rm = T),
    status_unknown90 = sum(
      IN_HOUSE_DEATH == 0 &
        (IN_HOUSE_DEATH_READMISSION == 0 | is.na(IN_HOUSE_DEATH_READMISSION)) &
        (DEATH == 9 | is.na(DEATH))),
    N =n(),
    N_adjust = N - status_unknown90,
    mort90_pst = (n_mort + status_unknown90)/N*100 |> round(1),
    mort90_pst_adjust = n_mort/N_adjust*100 |> round(1),
    .by = operation_group)

unknown <- regdata |>
  filter(IN_HOUSE_DEATH == 0 &
           (IN_HOUSE_DEATH_READMISSION == 0 | is.na(IN_HOUSE_DEATH_READMISSION)) &
           (DEATH == 9 | is.na(DEATH))) |>
  filter(operation_group != "Other",
         OPERATION_DATE < max(as.Date(regdata$OPERATION_DATE)) -
           lubridate::days(110))

table(unknown$operation_group)

table(unknown[, c("STATUS_READMISSION90", "FOLLOWUP_STATUS")], useNA = 'ifany')

tmp <- unknown |> filter(is.na(STATUS_READMISSION90))

comments <- unknown |>
  select(OPERATION_DATE, USERCOMMENT, USERCOMMENT_READMISSION,
         USERCOMMENT_READMISSION90, STATUS_READMISSION,
         STATUS_READMISSION90, FOLLOWUP_STATUS, DEATH,
         PATIENT_ID, MCEID)



ssn <- openxlsx::read.xlsx(paste0(tabfolder, "SRN_red.xlsx")) |>
  mutate(mrn.eden.2024 = trimws(mrn.eden.2024),
         SSN = trimws(SSN))

ssn_all_db <- trimws(patient$SSN)

setdiff(ssn$mrn.eden.2024, ssn$SSN)
setdiff(ssn$mrn.eden.2024, ssn_all_db)

missing <- data.frame(snn = setdiff(ssn$mrn.eden.2024, ssn_all_db))
write.csv(missing, paste0(tabfolder, "missing.csv"), row.names = FALSE)

nomatch <- data.frame(snn = setdiff(ssn_all_db, ssn$mrn.eden.2024))

# WITH patterns(pat) AS (
#   SELECT '983084064' UNION ALL
#   SELECT '930288818' UNION ALL
#   SELECT '964006446' UNION ALL
#   SELECT '921129420' UNION ALL
#   SELECT '920073179' UNION ALL
#   SELECT '940538229' UNION ALL
#   SELECT '920118255' UNION ALL
#   SELECT '903943836' UNION ALL
#   SELECT '910685188' UNION ALL
#   SELECT '985146400' UNION ALL
#   SELECT '964792121' UNION ALL
#   SELECT '921018640' UNION ALL
#   SELECT '917687931' UNION ALL
#   SELECT '965947376' UNION ALL
#   SELECT '917332113' UNION ALL
#   SELECT '917414040' UNION ALL
#   SELECT '911308382' UNION ALL
#   SELECT '910136185' UNION ALL
#   SELECT '929112176' UNION ALL
#   SELECT '925694328' UNION ALL
#   SELECT '983806924' UNION ALL
#   SELECT '911453682' UNION ALL
#   SELECT '934661245' UNION ALL
#   SELECT '911255189' UNION ALL
#   SELECT '910580151' UNION ALL
#   SELECT '913935234' UNION ALL
#   SELECT '920557415' UNION ALL
#   SELECT '923644097' UNION ALL
#   SELECT '900595600' UNION ALL
#   SELECT '927184162' UNION ALL
#   SELECT '913280779' UNION ALL
#   SELECT '923156621' UNION ALL
#   SELECT '920444011' UNION ALL
#   SELECT '968469128' UNION ALL
#   SELECT '946950331' UNION ALL
#   SELECT '921567635' UNION ALL
#   SELECT '912211251' UNION ALL
#   SELECT '986613452' UNION ALL
#   SELECT '925918819' UNION ALL
#   SELECT '932674378' UNION ALL
#   SELECT '912348765' UNION ALL
#   SELECT '919886437' UNION ALL
#   SELECT '913633928' UNION ALL
#   SELECT '900030030' UNION ALL
#   SELECT '938675176' UNION ALL
#   SELECT '940728676' UNION ALL
#   SELECT '910467600' UNION ALL
#   SELECT '912383459' UNION ALL
#   SELECT '925823329' UNION ALL
#   SELECT '913714964' UNION ALL
#   SELECT '911092655' UNION ALL
#   SELECT '93874045' UNION ALL
#   SELECT '913559657' UNION ALL
#   SELECT '919308734' UNION ALL
#   SELECT '951280217' UNION ALL
#   SELECT '940584436' UNION ALL
#   SELECT '932070541' UNION ALL
#   SELECT '921015810' UNION ALL
#   SELECT '911152970' UNION ALL
#   SELECT '912801722' UNION ALL
#   SELECT '934272458' UNION ALL
#   SELECT '965669575' UNION ALL
#   SELECT '944316040' UNION ALL
#   SELECT '915569193' UNION ALL
#   SELECT '920310874' UNION ALL
#   SELECT '923921304' UNION ALL
#   SELECT '922244216' UNION ALL
#   SELECT '923456789' UNION ALL
#   SELECT '938970161' UNION ALL
#   SELECT '983093899' UNION ALL
#   SELECT '934176810' UNION ALL
#   SELECT '912127093' UNION ALL
#   SELECT '913054513' UNION ALL
#   SELECT '912754838' UNION ALL
#   SELECT '900008182' UNION ALL
#   SELECT '910111580' UNION ALL
#   SELECT '914257265' UNION ALL
#   SELECT '921091845' UNION ALL
#   SELECT '922164782' UNION ALL
#   SELECT '926753719' UNION ALL
#   SELECT '938068396' UNION ALL
#   SELECT '927194086' UNION ALL
#   SELECT '911308618' UNION ALL
#   SELECT '900838948' UNION ALL
#   SELECT '944061428' UNION ALL
#   SELECT '910419456' UNION ALL
#   SELECT '940885535' UNION ALL
#   SELECT '910126912' UNION ALL
#   SELECT '910655932' UNION ALL
#   SELECT '941140992' UNION ALL
#   SELECT '910621412' UNION ALL
#   SELECT '900777964' UNION ALL
#   SELECT '912053409' UNION ALL
#   SELECT '902395201' UNION ALL7
#   SELECT '946939309' UNION ALL
#   SELECT '917813857' UNION ALL
#   SELECT '910977135' UNION ALL
#   SELECT '913249094' UNION ALL
#   SELECT '969485503' UNION ALL
#   SELECT '929044388' UNION ALL
#   SELECT '911818389' UNION ALL
#   SELECT '913990266' UNION ALL
#   SELECT '911124272' UNION ALL
#   SELECT '915574520' UNION ALL
#   SELECT '912071086' UNION ALL
#   SELECT '910174865' UNION ALL
#   SELECT '911042549' UNION ALL
#   SELECT '907036437' UNION ALL
#   SELECT '919776672' UNION ALL
#   SELECT '911466203' UNION ALL
#   SELECT '911708122' UNION ALL
#   SELECT '940305973' UNION ALL
#   SELECT '920625769' UNION ALL
#   SELECT '27839' UNION ALL
#   SELECT '1202331' UNION ALL
#   SELECT '1204494' UNION ALL
#   SELECT '1218963' UNION ALL
#   SELECT '697980' UNION ALL
#   SELECT '78265' UNION ALL
#   SELECT '1343257' UNION ALL
#   SELECT '1341046' UNION ALL
#   SELECT '1342847' UNION ALL
#   SELECT '142511' UNION ALL
#   SELECT '1344592' UNION ALL
#   SELECT '1342808' UNION ALL
#   SELECT '1344169' UNION ALL
#   SELECT '1303513' UNION ALL
#   SELECT '1293476' UNION ALL
#   SELECT '1293702' UNION ALL
#   SELECT '1297733' UNION ALL
#   SELECT '1295866' UNION ALL
#   SELECT '1297531' UNION ALL
#   SELECT '1299008' UNION ALL
#   SELECT '1299708' UNION ALL
#   SELECT '1299081' UNION ALL
#   SELECT '1249979' UNION ALL
#   SELECT '1077718' UNION ALL
#   SELECT '1300472' UNION ALL
#   SELECT '1268900' UNION ALL
#   SELECT '1302515' UNION ALL
#   SELECT '1303936' UNION ALL
#   SELECT '1302748' UNION ALL
#   SELECT '1304131' UNION ALL
#   SELECT '1304134' UNION ALL
#   SELECT '1306253' UNION ALL
#   SELECT '1305797' UNION ALL
#   SELECT '1305799' UNION ALL
#   SELECT '1306980' UNION ALL
#   SELECT '1308178' UNION ALL
#   SELECT '1309089' UNION ALL
#   SELECT '1309084' UNION ALL
#   SELECT '1309574' UNION ALL
#   SELECT '1309678' UNION ALL
#   SELECT '1309294' UNION ALL
#   SELECT '1309302' UNION ALL
#   SELECT '1309331' UNION ALL
#   SELECT '1310592' UNION ALL
#   SELECT '1310505' UNION ALL
#   SELECT '1310260' UNION ALL
#   SELECT '1310271' UNION ALL
#   SELECT '1310279' UNION ALL
#   SELECT '1247514' UNION ALL
#   SELECT '1310309' UNION ALL
#   SELECT '1312704' UNION ALL
#   SELECT '1312690' UNION ALL
#   SELECT '1313083' UNION ALL
#   SELECT '1313363' UNION ALL
#   SELECT '1313374' UNION ALL
#   SELECT '1312698' UNION ALL
#   SELECT '1312702' UNION ALL
#   SELECT '1295848' UNION ALL
#   SELECT '1313874' UNION ALL
#   SELECT '250752' UNION ALL
#   SELECT '1313795' UNION ALL
#   SELECT '1315887' UNION ALL
#   SELECT '1317101' UNION ALL
#   SELECT '643925' UNION ALL
#   SELECT '133130' UNION ALL
#   SELECT '1316272' UNION ALL
#   SELECT '131753' UNION ALL
#   SELECT '1324768' UNION ALL
#   SELECT '1255506' UNION ALL
#   SELECT '1327658' UNION ALL
#   SELECT '1327994' UNION ALL
#   SELECT '1328559' UNION ALL
#   SELECT '1328878' UNION ALL
#   SELECT '1329316' UNION ALL
#   SELECT '1329821' UNION ALL
#   SELECT '1329863' UNION ALL
#   SELECT '1329801' UNION ALL
#   SELECT '1330060' UNION ALL
#   SELECT '1330097' UNION ALL
#   SELECT '1330112' UNION ALL
#   SELECT '1330099' UNION ALL
#   SELECT '1330195' UNION ALL
#   SELECT '1332629' UNION ALL
#   SELECT '13344482' UNION ALL
#   SELECT '1334516' UNION ALL
#   SELECT '1334893' UNION ALL
#   SELECT '133628' UNION ALL
#   SELECT '1335783' UNION ALL
#   SELECT '1335715' UNION ALL
#   SELECT '1335728' UNION ALL
#   SELECT '1335739' UNION ALL
#   SELECT '1335745' UNION ALL
#   SELECT '1336560' UNION ALL
#   SELECT '1336563' UNION ALL
#   SELECT '1336779' UNION ALL
#   SELECT '1336798' UNION ALL
#   SELECT '1336789' UNION ALL
#   SELECT '133683' UNION ALL
#   SELECT '133449' UNION ALL
#   SELECT '1335650' UNION ALL
#   SELECT '1337612' UNION ALL
#   SELECT '1337464' UNION ALL
#   SELECT '1337812' UNION ALL
#   SELECT '1337791' UNION ALL
#   SELECT '1338671' UNION ALL
#   SELECT '1324128' UNION ALL
#   SELECT '1338715' UNION ALL
#   SELECT '1338717' UNION ALL
#   SELECT '1338734' UNION ALL
#   SELECT '1339865' UNION ALL
#   SELECT '1339145' UNION ALL
#   SELECT '1339164' UNION ALL
#   SELECT '1339176' UNION ALL
#   SELECT '1339247' UNION ALL
#   SELECT '1339243' UNION ALL
#   SELECT '1339244' UNION ALL
#   SELECT '1340611' UNION ALL
#   SELECT '1340635' UNION ALL
#   SELECT '1319975' UNION ALL
#   SELECT '1340580' UNION ALL
#   SELECT '21950' UNION ALL
#   SELECT '1340613' UNION ALL
#   SELECT '1137553' UNION ALL
#   SELECT '1340559' UNION ALL
#   SELECT '1340417' UNION ALL
#   SELECT '1341275' UNION ALL
#   SELECT '1342709' UNION ALL
#   SELECT '1325238' UNION ALL
#   SELECT '1342658' UNION ALL
#   SELECT '1342655' UNION ALL
#   SELECT '1042511' UNION ALL
#   SELECT '1342688' UNION ALL
#   SELECT '1342630' UNION ALL
#   SELECT '1342621' UNION ALL
#   SELECT '1344114' UNION ALL
#   SELECT '342477' UNION ALL
#   SELECT '1341345' UNION ALL
#   SELECT '1342450' UNION ALL
#   SELECT '1342190' UNION ALL
#   SELECT '1343430' UNION ALL
#   SELECT '1342160' UNION ALL
#   SELECT '1342088' UNION ALL
#   SELECT '1343250' UNION ALL
#   SELECT '1342564' UNION ALL
#   SELECT '1342371' UNION ALL
#   SELECT '1342527' UNION ALL
#   SELECT '1341367' UNION ALL
#   SELECT '1341427' UNION ALL
#   SELECT '1342752' UNION ALL
#   SELECT '1345268' UNION ALL
#   SELECT '1343855' UNION ALL
#   SELECT '1342800' UNION ALL
#   SELECT '1338566' UNION ALL
#   SELECT '1345654' UNION ALL
#   SELECT '1312032' UNION ALL
#   SELECT '138099' UNION ALL
#   SELECT '1346152' UNION ALL
#   SELECT '1346150' UNION ALL
#   SELECT '1345757' UNION ALL
#   SELECT '1345916' UNION ALL
#   SELECT '1347829' UNION ALL
#   SELECT '1347369' UNION ALL
#   SELECT '1345941' UNION ALL
#   SELECT '1347675' UNION ALL
#   SELECT '1347568' UNION ALL
#   SELECT '1346840' UNION ALL
#   SELECT '1346873' UNION ALL
#   SELECT '1346893' UNION ALL
#   SELECT '1346886' UNION ALL
#   SELECT '1346911' UNION ALL
#   SELECT '1243665'
# )
#
# SELECT *
#   FROM PATIENT t
# WHERE EXISTS (
#   SELECT 1
#   FROM patterns p
#   WHERE REGEXP_REPLACE(t.SNN,   '[^0-9]', '') LIKE CONCAT('%', p.pat, '%')
#   OR REGEXP_REPLACE(t.PHONE, '[^0-9]', '') LIKE CONCAT('%', p.pat, '%')
# );



ssn <- openxlsx::read.xlsx(paste0(tabfolder, "SRN.xlsx")) |>
  mutate(mrn.eden.2024 = trimws(mrn.eden.2024),
         SSN = trimws(SSN))

funnet <- read.csv("C:/Users/kth200/regdata/ethirgast/funnet.csv")

ssn_ny <- openxlsx::read.xlsx(paste0(tabfolder, "SRN_red.xlsx")) |>
  mutate(mrn.eden.2024 = trimws(mrn.eden.2024),
         SSN = trimws(SSN))

# missing_ny <- merge(missing, )

